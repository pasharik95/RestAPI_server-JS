// import module 'model' for working with mongodb
var model = require('model');

// import module 'passport' for authorization users
var passport = require('passport');

const successful_message = "New Number is added!!!";

// create controller for exporting it to view
var Controller = function ()
{
};

// define function add for adding new number to db
Controller.addNumber = function (nmbr, callback_func)
{
    // create new model for insert to db
    var newNumber = new model.ListOfNumbers(
      {
          number : nmbr,
          date : new Date() // current date, time
      });

    // insert new model to db
    newNumber.save(function (err)
    {
        if(err)
            throw err;

        callback_func(successful_message);
    })
};

// define function get in controller for getting one or all numbers from db
Controller.getNumber = function (nmbr)
{
    // define condition for finding all numbers
    var condition = {};


    if(nmbr)
        condition = {number : nmbr}; // define condition for finding one number

    // find numbers in db by condition
    model.find(condition, function (err, numbers)
    {

        if(err)
            throw err;

        return numbers;
    })
};

// define function get in controller for getting one or all numbers from db
Controller.addUser = function (username, password)
{
    // define condition for finding all numbers
    var condition = {};


    if(nmbr)
        condition = {number : nmbr}; // define condition for finding one number

    // find numbers in db by condition
    model.find(condition, function (err, numbers)
    {

        if(err)
            throw err;

        return numbers;
    })
};


// define function login user in controller
Controller.login = function (req, res, next)
{
    // callback function for checking login and pass of user
    passport.authenticate('local',
        function(err, user, info)
        {
            if (err) // This is error
            {
                return next(err);
            }

            if (!user) // User is not fouded
            {
                return res.redirect('/login');
            }

            req.logIn(user,
                function(err)
                {
                    if (err)
                    {
                        return next(err);
                    }

                    return res.redirect('/users/' + user.username);
                });
        })(req, res, next);
};

// define function add new user in controller
Controller.register = function (req, res, next)
{
    // create new user
    var user = new model.User(
        {
            username: req.body.username,
            password: req.body.password
        }
    )

    // insert user to db
    user.save(
        function (err)
        {
            if(err)
                throw err;

            Controller.login(req, res, next); // login new user
        });
};

// export controller to view(server)
module.exports = Controller;